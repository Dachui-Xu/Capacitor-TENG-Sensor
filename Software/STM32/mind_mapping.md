# 系统思维导图
## 一、任务概览
- **ADC_Task**
  - 功能：采集 10 路 ADC 电压值，转换为浮点型电压值，发送到队列 `xQueueADC`
  - 通信：
    - 使用 DMA 进行 ADC 数据传输
    - 使用信号量 `xADCSemaphore` 与 ADC 转换完成中断同步
    - 根据事件组 `xEventGroup` 的状态决定是否采集数据
- **FDC2214_Task**
  - 功能：采集 4 路电容值，发送到队列 `xQueueCap`
  - 通信：
    - 使用 I2C 与 FDC2214 通信
    - 使用互斥量 `xI2CMutex` 保护 I2C 资源，防止资源竞争
    - 根据事件组 `xEventGroup` 的状态决定是否采集数据
- **UART_Task**
  - 功能：从 `xQueueADC` 和 `xQueueCap` 中接收数据，格式化后通过 UART（DMA 方式）发送
  - 通信：
    - 使用信号量 `xUARTSemaphore` 与 UART 传输完成中断同步
    - 根据事件组 `xEventGroup` 的状态决定接收和发送的数据类型
- **Key_Task**
  - 功能：检测按键状态，切换系统模式，更新 LED 指示
  - 通信：
    - 使用事件组 `xEventGroup` 控制系统模式
    - 控制 LED1 和 LED2 的状态

## 二、通信机制
- **队列（Queue）**
  - `xQueueADC`
    - 生产者：`ADC_Task`
    - 消费者：`UART_Task`
  - `xQueueCap`
    - 生产者：`FDC2214_Task`
    - 消费者：`UART_Task`
- **事件组（Event Group）**
  - `xEventGroup`
    - 控制系统模式（MODE_ADC_ONLY_BIT、MODE_CAP_ONLY_BIT、MODE_BOTH_BIT）
    - 各任务根据事件组状态执行相应操作
- **信号量和互斥量**
  - **互斥量 `xI2CMutex`**
    - 用于保护 I2C 资源，防止多个任务同时访问 I2C
    - `FDC2214_Task` 在访问 I2C 时需要获取互斥量
  - **二值信号量 `xADCSemaphore`**
    - 用于 `ADC_Task` 与 ADC 转换完成中断之间的同步
  - **二值信号量 `xUARTSemaphore`**
    - 用于 `UART_Task` 与 UART 传输完成中断之间的同步

## 三、硬件资源
- **ADC1**
  - 使用 DMA1 Channel 1
  - 采集 10 路模拟信号
- **UART1**
  - 使用 DMA1 Channel 4（USART1_TX）
  - 波特率 115200，DMA 方式发送数据
- **I2C1**
  - 与 FDC2214 传感器通信
  - 使用互斥量保护 I2C 资源
- **GPIO**
  - **按键**：PA15，低电平按下，上拉输入
  - **LED1**：PC13，低电平点亮，指示 ADC 检测状态
  - **LED2**：PB14，低电平点亮，指示电容检测状态

## 四、任务优先级
- **Key_Task**：优先级 3（最高），确保按键响应及时
- **ADC_Task**：优先级 2
- **FDC2214_Task**：优先级 2
- **UART_Task**：优先级 1

## 五、模式控制逻辑
- **按键每按下一次，模式按以下顺序循环切换：**
  1. **ADC 检测模式（MODE_ADC_ONLY_BIT）**
     - 仅采集 ADC 数据
     - LED1 点亮，LED2 熄灭
  2. **电容检测模式（MODE_CAP_ONLY_BIT）**
     - 仅采集电容数据
     - LED1 熄灭，LED2 点亮
  3. **同时检测模式（MODE_BOTH_BIT）**
     - 同时采集 ADC 和电容数据
     - LED1 点亮，LED2 点亮

## 六、数据格式
- **串口输出格式：**
  - 浮点型数据，保留三位小数
  - 数据间用逗号 `,` 分隔
  - 每组数据以回车换行 `\r\n` 结束
  - 数据顺序：
    - **仅 ADC 模式**：输出 ADC 电压值
    - **仅电容模式**：输出电容值
    - **同时检测模式**：先输出电容值，再输出 ADC 电压值

## 七、注意事项
- **使用互斥量保护 I2C 资源**
  - 确保同一时间只有一个任务访问 I2C，防止资源竞争和数据冲突
  - `FDC2214_Task` 在访问 I2C 时获取互斥量，操作完成后及时释放
- **任务切换对 I2C 通信的影响**
  - 任务切换不会影响 I2C 通信的正确性，因为通信由硬件外设和中断驱动
  - 通过正确使用互斥量和任务设计，确保 I2C 通信在多任务环境下的正确性和稳定性
- **避免长时间占用资源**
  - 任务在获取互斥量后，应尽快完成操作，及时释放互斥量
  - 在任务中，避免使用长时间的阻塞调用或死循环
- **中断优先级**
  - 合理设置中断优先级，避免高优先级中断长时间占用 CPU，影响系统实时性